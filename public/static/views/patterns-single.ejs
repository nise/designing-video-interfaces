<% layout( 'layout' ) -%>





  <!-- Main component for a primary marketing message or call to action -->

<br><br><br>
<div class="col-md-8 portfolio-item" id="<%=: items.name | replace:/\ /g,'-'  %>">
	<div class="panel">
		<div class="panel-heading">
			<h4>
				<%= items.name %>
				<% if(items.confidence==1){  %>*<% } %>
				<% if(items.confidence==2){  %>**<% } %>	
				<% if(items.confidence==3){  %>***<% } %>
			</h4>
			<% if(items.illustration != undefined){  %><img class="pattern-illustration"src="<%= items.illustration %>"/><% } %>
		</div>	
		<div class="panel-body">
			<div class="context mark"><%= items.context  %></div>
			<div class="sep" hidden class="text-center pagination-centered">
				<span class="glyphicon glyphicon-play" aria-hidden="true"></span> 
			</div>
			<div class="problem" style="font-weight:bold;"><%=: items.problem | replace:'\n','' %></div>
			<div class="forces mark"><%= items.forces %></div>
			<div class="solution" style="font-weight:bold;"><%= items.solution %></div>
			<div class="consequences mark"><%= items.consequences %></div>
			<div class="examples"></div>
			<div class="evidence"></div> 
		</div>
	</div>		
</div>	

<div class="col-md-4">
	<div class="spacer200"></div>
	<a href="#" onclick="javascript:addToFav('<%= items.name %>')" class="button" title="Add pattern to favorites"> 				
		<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
		Add to favorites
	</a><br>
	<a class="button" href="/patterns/edit/<%=: items.name | replace:/\ /g,'-'  %>" title="Update this item item"> 				
		<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
		Edit
	</a>
	<br><br>
	<% if (items.related_patterns != undefined) { %>
	<label>Related Patterns:</label>
	<ul id="pattern_related">
		<% items.related_patterns.forEach( function ( related ){ %>
			<li><a href="/patterns/view/<%= related._id %>"><%= related.label %></a></li>
		<% }); %>	
	</ul>
	<% } %>		
	<label>Known Uses:</label>
	<ul id="pattern_known_uses"></ul>
	<br>
	
	<!-- Comments -->
	<a class="" data-toggle="collapse" href="#collapse-comments" aria-expanded="false" aria-controls="collapseExample">
		<span  class="right glyphicon glyphicon-comment" aria-hidden="true"></span> 
		Write a comment
	</a><br>
	<div class="collapse" id="collapse-comments"> 
		<!-- add new comment -->	
		<form id="commentForm" action="/messages/new" method="post" accept-charset="utf-8">
			<div class="input-group">
				<input type="hidden" name="context" value="<%= items.name %>" />
				<input type="hidden" name="type" value="pattern" />
				<input type="text" class="form-control" name="author" placeholder="Your name or email" aria-describedby="basic-addon2">
				<textarea name="message" class="form-control" placeholder="Your comment about that video application" aria-describedby="basic-addon3"></textarea><br>
			</div>
			<span class="input-group-btn">
		  		<button class="btn btn-default" type="submit">send</button>
			</span>
		</form>
	</div>
	<!-- List comments-->
	<div>
		<label>Comments</label>
		<span class="badge" id="comments-badge">0</span>
		<br>
		<ul id="commentsList"></ul>
	</div>
			
</div>


<script>
$(document).ready (function () {
	/*
	 * Images
	 **/  
	$.get('/json/images/by-pattern/<%=: items.name | replace:/-/g,' '  %>', function(data){
		$.each(data, function(i, val){ 
			var image = $('<img />')
				.attr('src', val.url)
				.attr('alt', val.filename);
			var link = $('<a></a>')
				.attr('href','#')
				.addClass('thumbnail')
				.append(image);
			var div = $('<div></div>')
				.append($('<h4></h4>').html('#'+(i+1)+': '+val.portal)) 	
				.append(link)
				.append($('<span></span>').html(val.caption))
				;
			$('.evidence')
				.append(div);
				
		});
	});	
	
	/*
	 * Related Portals / Known uses
	 **/
	$.get('/json/portals/patterns/<%=: items.name | replace:/-/g,' ' %>', function(data){ 
		$.each(data, function(i, val){ 
			$('#pattern_known_uses').append('<li><a href="/portals/view/'+ val._id +'">'+ val.name +'</a></li>')
		});
	});
	
	/*
	 * Comments
	 **/ 
	//$('#collapse-comments').click(function(){ $(this).fadeIn().toggle(); }); 
	$( "#commentForm" ).submit(function( event ) {
 		event.preventDefault();
	 	var $form = $( this ),
		  url = $form.attr( "action" );
	 	var posting = $.post( url, { 
	 			context: $form.find( "input[name='context']" ).val(),
	 			type: $form.find( "input[name='type']" ).val(),  
	 			author: $form.find( "input[name='author']" ).val(),
	 			message: $form.find( "textarea[name='message']" ).val()
	 		})
	 		.done(function( val ) {
	 			$('#comments-badge').text( Number($('#comments-badge').text()) + 1 );
	 			$('#collapse-comments').css({'background-color':'green'}).toggle(); //.fadeOut();//; 
				var arr = [
						'<li style="background-color:green;">',
						'<b>'+ $form.find( "input[name='author']" ).val() +': </b>',
						'<span>'+ $form.find( "textarea[name='message']" ).val() +'</span>',
						'</li>',
					];
				$('#commentsList').append( arr.join('') );
			});
	});
	 
	$.get('/json/messages/pattern/<%=: items.name | replace:/ /g,"_" %>', function(data){ 
		$('#comments-badge').text(data.length);
		$.each(data, function(i, val){
			// plot 10 recent comments
			if( i < 40 ){
				var arr = [
					'<li>',
					'<b>'+ val.author+': </b>',
					'<span>'+val.message+'</span>',
					'</li>',
				];
				$('#commentsList').append( arr.join('') );
			} 
		});// end each
	}); // end get
	
	
	
});	
</script>

	

